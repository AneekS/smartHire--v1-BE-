generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [citext, pg_trgm, uuid_ossp]
}

enum ProfileVisibility {
  PUBLIC
  APPLIED_ONLY
  PRIVATE
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  FREELANCE
  INTERNSHIP
}

enum AvailabilityStatus {
  ACTIVELY_LOOKING
  OPEN_TO_OFFERS
  NOT_LOOKING
}

enum ResumeParseStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  USER_CONFIRMED
}

enum SkillProficiency {
  BEGINNER
  ELEMENTARY
  INTERMEDIATE
  ADVANCED
  EXPERT
}

model CandidateProfile {
  id                    String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String    @unique @db.Uuid
  fullName              String    @db.VarChar(120)
  phoneCountryCode      String?   @db.VarChar(6)
  phoneNumber           String?   @db.VarChar(20)
  headline              String?   @db.VarChar(220)
  bio                   String?   @db.Text
  avatarUrl             String?   @db.Text
  locationCity          String?   @db.VarChar(100)
  locationState         String?   @db.VarChar(100)
  locationCountry       String?   @db.VarChar(100)  @default("IN")
  locationLatitude      Float?
  locationLongitude     Float?
  completenessScore     Int       @default(0)
  completenessBreakdown Json      @default("{}")
  isDeleted             Boolean   @default(false)
  deletedAt             DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  version               Int       @default(0)
  education             Education[]
  experience            WorkExperience[]
  skills                CandidateSkill[]
  careerIntent          CareerIntent?
  resumeVersions        ResumeVersion[]
  privacySettings       PrivacySettings?
  auditLogs             ProfileAuditLog[]

  @@index([userId])
  @@index([completenessScore])
  @@index([locationCountry, locationCity])
  @@index([isDeleted])
  @@map("candidate_profiles")
}

model Education {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId     String    @db.Uuid
  institution   String    @db.VarChar(200)
  degree        String    @db.VarChar(120)
  fieldOfStudy  String    @db.VarChar(120)
  startDate     DateTime  @db.Date
  endDate       DateTime? @db.Date
  isCurrent     Boolean   @default(false)
  grade         String?   @db.VarChar(20)
  description   String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  profile       CandidateProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("candidate_education")
}

model WorkExperience {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId       String    @db.Uuid
  company         String    @db.VarChar(200)
  role            String    @db.VarChar(150)
  employmentType  JobType   @default(FULL_TIME)
  startDate       DateTime  @db.Date
  endDate         DateTime? @db.Date
  isCurrent       Boolean   @default(false)
  location        String?   @db.VarChar(150)
  description     String?   @db.Text
  achievements    Json      @default("[]")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  profile         CandidateProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@map("candidate_work_experience")
}

model SkillCategory {
  id     String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name   String  @unique @db.VarChar(80)
  slug   String  @unique @db.VarChar(80)
  skills Skill[]

  @@map("skill_categories")
}

model Skill {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name            String         @unique @db.Citext
  slug            String         @unique @db.VarChar(100)
  categoryId      String         @db.Uuid
  aliases         String[]
  isVerifiable    Boolean        @default(false)
  category        SkillCategory  @relation(fields: [categoryId], references: [id])
  candidateSkills CandidateSkill[]

  @@index([categoryId])
  @@index([name])
  @@map("skills")
}

model CandidateSkill {
  id                  String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId           String           @db.Uuid
  skillId             String           @db.Uuid
  proficiency         SkillProficiency @default(INTERMEDIATE)
  yearsOfExp          Float            @default(0)
  isVerified          Boolean          @default(false)
  verifiedAt          DateTime?
  verificationSource  String?          @db.VarChar(100)
  endorsementCount    Int              @default(0)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  profile             CandidateProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill               Skill            @relation(fields: [skillId], references: [id])

  @@unique([profileId, skillId])
  @@index([profileId])
  @@index([skillId])
  @@index([proficiency])
  @@index([isVerified])
  @@index([profileId, proficiency])
  @@map("candidate_skills")
}

model CareerIntent {
  id                  String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId           String             @unique @db.Uuid
  preferredRoles      String[]
  preferredLocations  String[]
  salaryMinMonthly    Int?
  salaryMaxMonthly    Int?
  salaryCurrency      String             @default("INR") @db.VarChar(5)
  jobTypes            JobType[]
  openToRelocation    Boolean            @default(false)
  availability        AvailabilityStatus @default(OPEN_TO_OFFERS)
  noticePeriodDays    Int?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  profile             CandidateProfile   @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([availability])
  @@index([openToRelocation])
  @@map("candidate_career_intent")
}

model ResumeVersion {
  id               String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId        String            @db.Uuid
  versionNumber    Int
  fileName         String            @db.VarChar(255)
  fileMimeType     String            @db.VarChar(80)
  fileSizeBytes    Int
  storageKey       String            @db.Text
  parseStatus      ResumeParseStatus @default(PENDING)
  parsedData       Json?
  isActive         Boolean           @default(true)
  userConfirmed    Boolean           @default(false)
  userConfirmedAt  DateTime?
  parseJobId       String?           @db.VarChar(100)
  parseFailReason  String?           @db.Text
  uploadedAt       DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  profile          CandidateProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@unique([profileId, versionNumber])
  @@index([profileId, isActive])
  @@index([parseStatus])
  @@map("resume_versions")
}

model PrivacySettings {
  id                        String            @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId                 String            @unique @db.Uuid
  profileVisibility         ProfileVisibility @default(APPLIED_ONLY)
  allowRecruiterMessaging   Boolean           @default(true)
  hideFromCompanies         String[]
  gdprConsentGiven          Boolean           @default(false)
  gdprConsentAt             DateTime?
  marketingConsentGiven     Boolean           @default(false)
  dataRetentionOptOut       Boolean           @default(false)
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  profile                   CandidateProfile  @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@map("candidate_privacy_settings")
}

model ProfileAuditLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profileId   String    @db.Uuid
  actorId     String    @db.Uuid
  actorRole   String    @db.VarChar(50)
  action      String    @db.VarChar(100)
  entityType  String    @db.VarChar(80)
  entityId    String?   @db.Uuid
  diff        Json?
  ipAddress   String?   @db.VarChar(45)
  userAgent   String?   @db.Text
  createdAt   DateTime  @default(now())
  profile     CandidateProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId, createdAt])
  @@index([actorId])
  @@index([action])
  @@map("profile_audit_logs")
}
